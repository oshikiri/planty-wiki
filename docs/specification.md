# 機能要件

## 概要

- 技術スタック: TypeScript + Preact + Vite + Lexical + SQLite WASM on OPFS
- UIのラベルやプレースホルダー、ユーザーに見せるステータスメッセージや通知文言は、英語で統一する
- 表示/ルーティング
    - `/pages/[マークダウンファイルの名前をURLエンコードしたもの]` 形式でルーティングする。
    - 存在しないページにルーティングした場合は、空ページを作成し、新しく記入できるようにする
    - SQLクエリ実行ページは`/tools/query`で開き、SELECTまたはWITHクエリの結果を表形式で表示する

## 実行環境

- 対応ブラウザ: Chrome>=142
    - その他のブラウザは未検証。
- シークレットウィンドウやゲストモードは、ブラウザ終了時にデータが消えるため非対応とする。
- 複数のブラウザで自動同期することはできないため、必ず単一のブラウザで利用する。
- OPFSを有効にするため、HTTPS配信または `http://localhost` 環境で利用する。

## 保存/同期

- インポートや一括保存の入力データは1件ずつ検証しつつ挿入する
    - 不正なレコードがあればトランザクション全体を失敗させ、DBに不正なデータが混入しないようにする
- 保存済みデータを削除するUIでは。必ず確認ダイアログやUndoバー等の安全策を提示し、誤操作で即時削除されないようにする
- ある差分のストレージへの保存が失敗しても、その差分を削除せずに保持し、復旧後に再保存できるようにする
- 中間テーブルとして SQLite WASM に保存し、通常時はそこから読み書きする。
- ユーザーが選択したローカルディレクトリからMarkdownをインポートする機能を用意する。
- Markdownフォルダからインポートした際は、既存のSQLiteデータベースをクリアして、インポートした内容で上書きする。
- 編集中に数秒入力が止まったときは、内容を自動保存しSQLiteに変更を反映する。
- Markdownファイルへの書き出しはExportボタンを押したときのみ実行する。通常の自動保存では走らせない。
- 取り込み後にファイルが更新され競合が発生した場合はファイル側を無視し、再エクスポートでDBを正として上書きする。

## マークダウン

- `[[Page]]` 形式のwikiリンクをサポートする。本文中では強調表示し、クリックで対応するページを開く。
- 画像埋め込み記法（`![alt](url)`）は非対応。単に本文中の文字列として保存する
    - 将来的に画像埋め込みをサポートする可能性はあるものの、現時点では `![...]` をそのままの文字列として受け入れる
- マークダウンのポータビリティ性を高めるため、独自のマークダウン拡張はできるだけ使わない

## 配布形態

- 静的ホスティング: GitHub Pages に配置する。
- SQLite WASM関連ファイルは公式配布物をリポジトリの `/public/sqlite3.{js,wasm}` として直接配置し、`sqlite-opfs-worker.js` や `sqlite3-opfs-async-proxy.js` と合わせて配布する。
- 画像や添付ファイルは現時点でサポートしていない。
- アプリ全体のインストール・オフラインキャッシュも提供しない。

## 既知の制約

- DBスキーマのマイグレーションは自動化されていないため、スキーマ変更時にデータが失われる恐れがある。
- データは利用中のブラウザプロファイルごとにローカル保存される。サーバーやクラウドに自動同期しないため、複数端末同期は非対応。
- ブラウザのストレージをクリアした場合やプロファイルを削除した場合はノートが失われる。
- SQLite/OPFSを使った保存はChromeのcrossOriginIsolated環境を前提となっている。条件を満たさない場合はメモリ上でのみ動作してデータが保持されない。
- 複数タブから編集したときの動作が保証できていない。