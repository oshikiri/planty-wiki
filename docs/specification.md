# 機能要件

## 概要

- TypeScript + Preact + Vite + SQLite WASM on OPFS
- UIのラベルやプレースホルダー、ユーザーに見せるステータスメッセージや通知文言は英語で統一する
- 表示/ルーティング
    - `/pages/[マークダウンファイルの名前をURLエンコードしたもの]` 形式でルーティングする。
    - 存在しないページにルーティングした場合は、空ページを作成し、新しく記入できるようにする
    - SQLクエリ実行ページは`/tools/query`で開き、SELECTまたはWITHクエリの結果を表形式で表示する

## 実行環境

実行環境はChrome v142以降に限定する。
その他のブラウザは未検証。

- シークレットウィンドウやゲストモードではブラウザ終了時にデータが消えるため、通常ウィンドウで利用する。
- 複数のブラウザで自動同期することはできない。常に単一のブラウザで利用する。
- HTTPS配信または`http://localhost`でアクセスしてOPFSを有効にする。

## 保存/同期

- インポートや一括保存の入力データは1件ずつ必須項目と最大長を検証し、不正なレコードがあればトランザクション全体を失敗させてDBを汚さないようにする
- 保存済みデータを削除するUIでは必ず確認ダイアログやUndoバー等の安全策を提示し、誤操作で即時削除しないようにする
- ある差分のストレージへの保存が失敗しても、その差分が消滅しないように削除せずに保持し、復旧後に再保存できるようにする
- 中間テーブルとして SQLite WASM に保存し、通常はそこからやり取りする。
- 最初のインポート元、およびエクスポート操作時のバックアップ先としてマークダウンファイル群をOPFSに置く。
- 初回Markdownインポート時のUXを用意する。
- Markdownフォルダからインポートすると既存のSQLiteデータベースをクリアして、インポートした内容で置き換える。
- 編集内容は数秒入力が止まると自動保存し、SQLiteのみに反映する。
- Markdownファイルへの書き出しはExportボタンを押したときのみ実行し、通常の自動保存では走らせない。
- 取り込み後にファイルが更新され競合が発生した場合はファイル側を無視し、再エクスポートでDBを正として上書きする。

## マークダウン

- `[[Page]]` 形式のwikiリンクをサポートし、本文中で強調表示してクリックで対応するページを開くようにする。
- 画像埋め込み記法（`![alt](url)`）は画像を描画せず、本文中の文字列として保存する
    - 将来的に画像埋め込みをサポートする可能性はあるものの、現時点では `![...]` をそのままの文字列として受け入れる
- できるかぎりマークダウンのポータビリティ性を高めるため、独自のマークダウン拡張はできるだけ使わない

## 配布形態

- 静的ホスティング: GitHub Pages に配置する。
- SQLite WASM関連ファイルは公式配布物をリポジトリの`/public/sqlite3.{js,wasm}`として直接配置し、`sqlite-opfs-worker.js`や`sqlite3-opfs-async-proxy.js`と合わせて配布する。
- 画像や添付ファイルは現時点でサポートしていない。
- アプリ全体のインストール・オフラインキャッシュも提供しない。

## 既知の制約

- Service Workerは添付配信用のみに限定されており、DBスキーマのマイグレーションは自動化していないため必要に応じて手動でバックアップと更新手順を案内する。
- データは利用中のブラウザプロファイルごとにローカル保存し、サーバーやクラウドには自動同期しない。
- ブラウザのストレージをクリアした場合やプロファイルを削除した場合はノートが失われるため、適宜Markdownエクスポートでバックアップを取得する。
- SQLite/OPFSを使った保存はChromeのcrossOriginIsolated環境を前提にし、条件を満たさない場合はメモリ上でのみ動作してデータが保持されないことに注意して利用する。
- 複数タブで同じノートを同時に編集した場合は最後に保存した内容が優先されるため、同じノートは一つのタブで編集する。
