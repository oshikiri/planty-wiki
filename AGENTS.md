# AGENTS

## 共通
- 私とのコミュニケーションは日本語で行うこと。
- コードコメントは英語で書くこと。
- 体言止めは使わないこと。文章や箇条書きも動詞終わりにする。
- 文章を書くときは一文一義を徹底する。長い修飾で読みにくくなったら即座に文を分割して読み手の負荷を減らすこと
- 意図が理解しやすい文章を常に書くこと

## Planty-Wiki
- 詳細な仕様は docs/index.md に記載する

### ドキュメントの管理
- 実装計画やREADMEに記載したフェーズの完了状態と実装内容がずれた場合は、コード変更に合わせて計画ドキュメント側も更新すること
- MarkdownエディタやWiki機能を実装するときはサポートしている記法をドキュメントに一覧化し仕様変更時に必ず更新するようにする。
  - 例: [[docs/MarkdownSyntax]]
- Markdownの記法ドキュメントでは見出しやリンクなど各カテゴリごとに少なくとも一つ以上の具体的な記述例を併記して読み手がすぐに使い方を理解できるようにする。
  - 例: `## 見出し` と `[[PageLink]]`
- docs/journals/ にあるマークダウンは更新されないため、最新の仕様については他の箇所を参考にすること

## 一般的なコーディング
- 関数の長さが50行を超えたら、処理の一部を切り出せないかを検討する
  - 機能追加で関数の行数が増えた場合は差分後に必ず再チェックし、50行を超えたら即座に切り出せる範囲がないか検討する
- モジュール名と責務がずれてきた場合は、ファイル名とimportパスのリネームを行い、命名と責務が一致するように整理すること
- 未使用になった関数やpropsや変数を見つけたら即座に削除すること
- デフォルト値やシードデータは定数としてまとめ、複数箇所で重複させないこと
- whyがわかりにくい部分や紛らわしいトリックがある場合は、実装を簡潔に整えるかコメントで背景や安全性の理由を説明すること
- 既存のコードコメントやレビューコメントは理由なく削除しないこと
- コード変更して私に報告する前には以下を実行すること
  - `npm run lint`
  - `npm run typecheck`
  - `npm run format`
  - `npm run build`
  - `npm test`
- 差分説明やレビュー対応では、変更意図・必要性・未対応時の影響を明確に説明し、今後の判断材料を共有する
- 同じ関数の中で処理の抽象度は揃える
  - 例えばReactコンポーネントの中で文字列操作したい場合は関数に切り出す
- UIから参照していないDBテーブルやデータ構造は維持せず、不要になった時点で削除して責務をシンプルにする

## TypeScript/Node.js
- TSDoc
  - export関数にはTSDocを必ずつけること
  - 関数全体の概要を先に述べる
  - その後に@params/@returnsを記述する
- 外部から使用していないexport（関数・変数・型など）を見つけたら削除または非公開化すること
- モジュール内でしか使わないユーティリティ関数は必ずexportの後方に配置し、原則としてそのファイル内に収めること。
  - 必要があって別ファイルへ切り出す場合でも同じディレクトリに置いて距離を縮め、後から削除しやすい構
- サプライチェーン攻撃に備えて以下を徹底する
  - 作業の中で `npm install` は実行しないこと
  - package.jsonのバージョン指定で `^` を使わないこと
- 非同期処理を実装する際は、Promiseよりasync/awaitを使う。エラーハンドリングに関しても、try/catchにまとめて可読性を上げる
- テストを追加する際は、実装と同じディレクトリに `*.test.ts` を置き、Vitest (`describe`/`it`/`expect`) ベースでテストを書く
成にすること

## Preact
- コンポーネントの書き方
  - コアコンポーネント（Appなど）はファイル先頭に配置し、補助UI/ヘルパーを後方にまとめる。規模拡大時は別ファイル切り出しを検討する。
  - App.tsx内の初期ロード処理や削除/選択/自動保存/ハッシュ監視ハンドラのように長くなりがちなuseEffect/useCallbackは、専用フックへ切り出して本体を簡潔に保つこと
  - コンポーネントは肥大化しがちなので、責務ごとにカスタムフックやモジュールへ即座に切り出して可読性を保つこと
  - イベントハンドラやコールバックが長くなりそうな場合は、削除後の選択ロジックなどの複雑な処理を専用ヘルパー関数に切り出すこと。
- 参照されていないCSSは消すこと
- JSX属性はReact/Preactが期待するプロップ名（例: labelでは`htmlFor`）を使い、DOM属性名を直書きして型エラーを出さないようにする
- フォームや検索入力ではplaceholderだけに頼らず、必ずlabelやaria-labelでスクリーンリーダーに説明を伝えるようにする
- ストレージやネットワークへの初期化処理では例外が発生してもUI全体が空白にならないようにtry/catchでフォールバックを実装するようにする
- バックリンク生成やノート一覧の描画など件数が増える処理は、全件スキャンやDOM全描画を続けずに早期に仮想リスト化やSQLiteインデックスを導入してメインスレッドをブロックしないようにする
- バックリンクやWikiリンクの参照関係はSQLiteのlinksテーブルなど補助構造に永続化し、UIはlistBacklinks等のストレージAPI経由で取得するようにして全件走査を避けること
- ディレクトリインポートやワーカー越しのストレージ操作など長時間処理には並列数の制御・深さ/件数上限・キャンセルプロトコルを必ず設計し、ブラウザをフリーズさせないようにする
- Reactなどのリスト描画では、セクションが分かれていてもkeyが衝突しないようprefixを付けるなどして常に一意になるようにすること

## Lexical
- 検索やAPI呼び出しを伴うテキスト入力は300ms程度デバウンスし、リクエストIDなどで最新レスポンスのみをUIへ反映して結果の取り違えを防ぐようにする
- Lexicalのチェックリストは `::before` 疑似要素の幅でクリック判定するため、スタイル調整でも `::before` でマーカーを描画してクリックを阻害しないようにする
- Tabキーの挙動はLexicalのTabIndentationPluginなど既定のインデント/アウトデントロジックを使い、カスタムプラグインでスペース挿入に置き換えないようにする
- Markdownのリストインデントは4スペースを前提とし、2スペース記法はサポート対象外とする。Tab入力やImport時も同ルールを徹底する
- Lexical固有のスタイルはcomponents/lexical配下の専用CSSに集約し、クラス名は `lexical-` 接頭辞で統一する
- Lexicalのカスタムプラグインは`components/lexical/plugins/`配下へ集約し、エディタ本体からはそのディレクトリ経由でimportする
- Markdown文字列からの再インポートはノート切り替え時のみ行い、同じノートのautosaveではEditorStateを上書きせずキャレット位置を保持する（コメントやログの言語も日本語で統一する）

## Web Security
- window.location.hashなどブラウザのロケーションAPIへユーザー入力を流すときは、`/pages/`などプレフィックスのスラッシュは保ったまま各セグメント単位でencodeURIComponentを適用してパストラバーサルやXSSを防止すること
- Wikiリンクや入力パスを扱う際はnormalizePath相当のロジックで`.`や`..`を解決し、常にルート起点の安全なパスだけを保存・遷移させること
- 外部ソース（Markdown importなど）から取り込むパスも必ずnormalizePath経由で検証し、危険な相対パスや制御文字を弾くこと
